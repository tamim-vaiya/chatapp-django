{% extends "base.html" %}

{% block body %}
    <h1 class="text-2xl font-bold text-indigo-600 mb-4">{{ chatroom.name }}</h1>

    <!-- Chat Messages -->
    <div id="chat-messages" 
         class="h-96 overflow-y-auto bg-white border border-gray-200 rounded-xl p-4 space-y-2 mb-4 shadow">
        {% for message in messages %}
            <div class="p-2 rounded-md bg-gray-100">
                <span class="font-semibold text-indigo-600">{{ message.user }}</span> :
                <span>{{ message.message_content }}</span>
            </div>
        {% empty %}
            <p class="text-gray-500">No messages yet. Be the first to say hi!</p>
        {% endfor %}
    </div>

    <!-- Chat Form -->
    <form method="POST" class="flex space-x-2">
        {% csrf_token %}
        <input id="message-input" type="text" name="message" placeholder="Enter message..."
               class="flex-1 px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="send-button" type="submit"
                class="px-5 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition">
            Send
        </button>
    </form>

    {{ chatroom.slug|json_script:"json-chatroomname"}}
    {{ request.user.username|json_script:"json-username"}}

    <script>
        const chatRoomName = JSON.parse(document.getElementById('json-chatroomname').textContent)
        const username = JSON.parse(document.getElementById('json-username').textContent)

        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/' + chatRoomName + '/'
        )

        chatSocket.onmessage = function(e){
            const data = JSON.parse(e.data)
            if(data.message){
                let html = `
                    <div class="p-2 rounded-md bg-indigo-50">
                        <span class="font-semibold text-indigo-600">${data.username}</span> :
                        <span>${data.message}</span>
                    </div>`;
                document.getElementById('chat-messages').innerHTML += html;
                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight
            }
        }

        chatSocket.onclose = function(e){
            console.log('Socket closed')
        }

        document.getElementById('send-button').onclick = function(e) {
            e.preventDefault()
            const messageInput = document.getElementById('message-input')
            const message = messageInput.value.trim()

            if (message.length > 0) {
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'username': username,
                    'room': chatRoomName,
                }))
                messageInput.value = ''
            }
        }
    </script>
{% endblock body %}
